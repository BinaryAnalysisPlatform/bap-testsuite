set test "run"

set outputs {
hello
cruel
world
we
not
are
some
thine
the
be
course
}

puts "running $test"

set base_opts {
    --run-argv='hello,cruel,world'
    --symbolizer=file
    --no-ida
    --no-objdump
    --run
}

set mips32 "mips-linux-gnu-echo"
set mips64 "mips64-linux-gnueabi-echo"

set bins [subst {
    "arm-linux-gnueabi-echo"
    "x86-linux-gnu-echo"
    "x86_64-linux-gnu-echo"
    "$mips32"
    "$mips64"
}]

foreach output $outputs {
    foreach bin $bins {
        set opts $base_opts
        if { $bin == "$mips64" } {
            lappend opts "--primus-lisp-add site-lisp --primus-lisp-load mips --primus-limit-max-length=5000"
        } else {
            if { $bin == "$mips32" } {
                lappend opts "--primus-limit-max-length=5000"
            } else {
                lappend opts "--primus-lisp-load=posix"
            }
        }
        eval spawn bap "bin/$bin" --read-symbols-from "data/$bin.symbols" [join $opts " "]
        expect {
            $output {pass "$test $bin outputs $output" }
            timeout {fail "got timeout"}
            default {fail "missing '$output' in output of $bin"}
        }
    }
}
